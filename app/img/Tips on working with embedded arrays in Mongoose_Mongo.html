<!DOCTYPE html>
<!-- saved from url=(0083)http://www.jonahnisenson.com/tips-on-working-with-embedded-arrays-in-mongoosemongo/ -->
<html class="no-js" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Tips on working with embedded arrays in Mongoose/Mongo</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1, user-scalable=no">

    <link rel="shortcut icon" href="http://www.jonahnisenson.com/favicon.ico">
    <!--Code styling using Prism.js-->
    <link rel="stylesheet" type="text/css" href="./Tips on working with embedded arrays in Mongoose_Mongo_files/prism.css">

  <!-- Google Authorship and Publisher Markup -->
    <link rel="author" href="https://plus.google.com/+MaxHolland1337">
    

    <link rel="stylesheet" type="text/css" href="./Tips on working with embedded arrays in Mongoose_Mongo_files/peeves.css">

    <meta name="generator" content="Ghost 0.5">
<link rel="alternate" type="application/rss+xml" title="Jonah Nisenson: Journey Into Coding" href="http://www.jonahnisenson.com/rss/">
<link rel="canonical" href="./Tips on working with embedded arrays in Mongoose_Mongo_files/Tips on working with embedded arrays in Mongoose_Mongo.html">


<style type="text/css"></style><script type="text/javascript" async="" src="./Tips on working with embedded arrays in Mongoose_Mongo_files/embed.js"></script><style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style><script src="./Tips on working with embedded arrays in Mongoose_Mongo_files/alfie.f51946af45e0b561c60f768335c9eb79.js" async="" charset="UTF-8"></script></head>
<body itemscope="" itemtype="http://schema.org/Blog" class=" pace-done" data-lang="en" data-os="linux" data-device="desktop" data-orientation="landscape" data-screen="normal" data-retina="false"><div class="pace  pace-inactive"><div class="pace-progress" data-progress-text="100%" data-progress="99" style="transform: translate3d(100%, 0px, 0px);">
  <div class="pace-progress-inner"></div>
</div>
<div class="pace-activity"></div></div>
    <!--[if lt IE 10]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <aside id="sidebar" class="sidebar">
         <ul>
         <li class="side-header">Links</li>
         <li><a href="http://www.jonahnisenson.com/">Home </a></li>
         <li><a href="http://www.jonahnisenson.com/about">About me</a></li>
         <li><a href="http://www.jonahnisenson.com/rss">RSS</a></li>
         
         
         <li class="side-header">Follow Me</li>
         <li><a href="https://twitter.com/jnisenson" target="_blank">Twitter</a></li>
         <li><a href="https://github.com/jnis77diver" target="_blank">Github</a></li>
         
         <!-- Begin MailChimp Signup Form -->
         <div id="mc_embed_signup">
         <form action="http://californianandcolombiana.us8.list-manage.com/subscribe/post?u=d227cffcb6fcc20b5ea5f6372&id=306f786634" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
             <div id="mc_embed_signup_scroll">
           <h2>Subscribe to my mailing list</h2>
         <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
         <div class="mc-field-group">
           <label for="mce-EMAIL" id="mc-email">Email Address  <span class="asterisk">*</span>
         </label>
           <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
         </div>
           <div id="mce-responses" class="clear">
             <div class="response" id="mce-error-response" style="display:none"></div>
             <div class="response" id="mce-success-response" style="display:none"></div>
           </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
             <div style="position: absolute; left: -5000px;"><input type="text" name="b_d227cffcb6fcc20b5ea5f6372_306f786634" tabindex="-1" value=""></div>
             <div class=""><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn btn-default button"></div>
             </div>
         </form>
         </div>
         
         <!--End mc_embed_signup-->
        </ul>
    </aside>

    <div class="page-wrapper">
        <nav id="navbar" class="navbar">
         <button class="menu-btn" id="openMenu"><span class="table-span"><span><i class="fa fa-bars"></i></span></span></button>
        </nav>




    




 <span itemscope="" itemtype="http://schema.org/BlogPosting">
    <header class="main-header post-page-header" style="background-image: url()">
      <div class="wrapper">
          <div class="grid-container grid-720">

            <div class="inner-header">
            <span class="table-span">
                <span>
                    <h1 itemprop="name">Tips on working with embedded arrays in Mongoose/Mongo</h1>
                     <ul>

                    <li class="hide-on-mobile">
                          <img class="author-image" src="./Tips on working with embedded arrays in Mongoose_Mongo_files/0d9cfed41ac9795f7c20dd8440ff5fd9" alt="Jonah Nisenson">
                          <span class="author-info">Jonah Nisenson
                        in <a href="http://www.jonahnisenson.com/tag/mongodb/">MongoDB</a> , <a href="http://www.jonahnisenson.com/tag/mongoose/">Mongoose</a> , <a href="http://www.jonahnisenson.com/tag/node-js/">Node.js</a></span>
                          <span class="author-info hide-on-mobile" style="float:right;">&nbsp;read</span>
                          <span class="author-info post-reading-time " style="float:right;">10 min</span>
                      </li>
                      <li class="hide-on-desktop hide-on-tablet">
                            <span class="author-info">Jonah Nisenson
                        </span>
                          <span class="author-info post-reading-time" style="float:right;">10 min</span>
                      </li>

                    </ul>

                </span>
            </span>
            </div>
          </div>
        </div>
    </header>


    <section id="post-container" role="main" class="main-section show-post">
        <div class="grid-container grid-720">

        <article class="post post-page-post" id="19">
          <div class="wrapper">
              <section class="post-text" itemprop="articleBody text">
                  <h2 id="whymongooseandmongodb">Why Mongoose and MongoDB?</h2>

<p>MongoDB uses Document Oriented Storage in JSON-style documents. Mongoose is an object relational modeling (ORM) system that bridges Node.js and MongoDB. Running Node.js as a server and using Mongoose and MongoDB for the database system is a popular choice that provides advantages such as scaleability, simplicity of a document object systyem that maps nicely to programming language data types and no complex database joins (which you would find with a Relational Database). </p>

<p>While working with queries and updates on a simple document object can be straight-forward, when data gets more complex and nested, queries and updates become more complicated and finding the appropriate query for a specific situation can be difficult. This post attempts to provide several tips for working with embedded arrays.</p>

<h2 id="exampleanappthatmanagescreationofmeetings">Example: an app that manages creation of meetings</h2>

<p>Let's take a simple example of building out methods for interacting with a database that is storing information for an app that is used for creating meetings. Our datbase will have at a bare minimum a Users Collection and a Meetings Collection. Collections, in case you are just learning about MongoDB, are roughly the equivalent of a Relational Database Management System (RDBMS) table. Collections hold documents which are objects with key/value pairs. As with any plain-old JavaScript object, the values can be any primitive value but can also be objects or arrays. This is far different than an RDBMS which maps data differently. Since there is no relational mapping in MongoDB, you will often be storing a lot of data in a nested way.</p>

<p>For example, here is what a document (object) in our Meetings Collection might look like. I'm using <a href="http://robomongo.org/">RoboMongo</a> for data visualization here which is a tool that allows you to interact with and visualize a MongoDB database.</p>

<p><a class="fluid-popup fluidbox" href="./Tips on working with embedded arrays in Mongoose_Mongo_files/mongo-blog-1.png" id="fluidbox-1"><div class="fluidbox-wrap" style="z-index: 990;"><img src="./Tips on working with embedded arrays in Mongoose_Mongo_files/mongo-blog-1.png" alt="Document in MongoDB Meetings Collection" style="opacity: 1;"><div class="fluidbox-ghost" style="width: 700px; height: 215px; top: 0px; left: 0px;"></div></div></a></p>

<p>This document has seven key/value pairs:</p>

<ul>
<li><strong>_id</strong> - the auto-generated id for the document</li>
<li><strong>name</strong> - String: the name for the Meeting ('test2' in this case)</li>
<li><strong>info</strong> - String: used for any meeting specific info</li>
<li><strong>active</strong> - Boolean: if the meeting is active or not (might be over in which case we would make it inactive but keep the data)</li>
<li><strong>messages</strong> - Array: an array of all messages about the meeting that have occurred in the meeting chats</li>
<li><strong>users</strong> - Array: an array of people invited to the meeting</li>
<li><strong>_v</strong> - the versionKey is a property set on each document which gets incremented whenever an internal array is updated or modified. It is used to ensure that two updates happening simultaneously don't conflict.</li>
</ul>

<h2 id="pushingtoembeddedarray">Pushing to embedded array</h2>

<p>Let's focus on arrays since updating the other key/value pairs when they are primitive values is fairly trivial. Suppose we wanted to update the datbase with a new message that was captured when someone submitted a new message in the meeting chat room, we could do something like this:</p>

<pre><code class=" hljs javascript">Meetings.findById(MeetingId, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, meeting)</span> {</span>
  <span class="hljs-comment">// handle errors ..</span>
  meeting.messages.push({ userId: userId, username: username, message: message, date: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() });
  post.save(callback);
})
</code></pre>

<p>The MeetingId, userId, username, and message would be available to us from the communication we received from the client, whether by an HTTP POST request or using Socket.io.</p>

<p>You could also do this using the following syntax which is perhaps harder to read:</p>

<pre><code class=" hljs php">Meetings.update({ <span class="hljs-string">"_id"</span>: MeetingId },
    {<span class="hljs-variable">$push</span>: { <span class="hljs-string">"messages"</span>: message }},
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, numAffected)</span> {</span>
      <span class="hljs-keyword">if</span>(err) {<span class="hljs-comment">//handle error}</span>
      <span class="hljs-keyword">else</span> { 
        <span class="hljs-comment">//do something depending on the number of documents affected</span>
      }});
</code></pre>

<p>Again, this is equivalent to pushing to the embedded array as shown in the code above but one could argue that it is harder to follow what is going on. Basically, we search for the document (object) with the desired meeting id (_id), then find the messages array, then push our new message to that array. The third parameter in the collection <code>update</code> method is a callback function that will return the number of documents affected, 0 for none or 1 if our document was updated. This can be used to communicate back to the client if the document was successfully updated.</p>

<p>The process goes like this. We find the meetingId, create a variable that points to the object in our messages array that we want to update, change the message for that message object, then save it to the MongoDB. </p>

<p>Let's break this down a little bit more to understand the syntax. The basic syntax is the following:</p>

<pre><code class=" hljs sql">Model.<span class="hljs-operator"><span class="hljs-keyword">update</span>(conditions, <span class="hljs-keyword">update</span>, options, callback);</span>
</code></pre>

<p>The first argument to the <code>update</code> method is conditions, i.e. the search query. The second is what to update, the third are options for the update, and the fourth is a callback function. We could rewrite our <code>Meetings.update</code> method call in a more readable way by first defining our conditions, update, options and callback.   </p>

<pre><code class=" hljs php"><span class="hljs-keyword">var</span> conditions = { <span class="hljs-string">"_id"</span> : meetingId };
{<span class="hljs-variable">$push</span>: { <span class="hljs-string">"messages"</span>: message }}
<span class="hljs-comment">//options not included in above code</span>
<span class="hljs-keyword">var</span> options = { multi: <span class="hljs-keyword">false</span> };
<span class="hljs-keyword">var</span> callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, numAffected)</span> {</span>
  <span class="hljs-comment">//handle errors</span>
  <span class="hljs-comment">// numAffected is the number of updated documents</span>
});
</code></pre>

<p>So, my method call would simply look like this:</p>

<pre><code class=" hljs sql">Model.<span class="hljs-operator"><span class="hljs-keyword">update</span>(conditions, <span class="hljs-keyword">update</span>, options, callback);</span>
</code></pre>

<h2 id="updatinganembeddedarray">Updating an embedded array</h2>

<p>Now, let's deal with something trickier; updating something that already exists within the embedded array. Let's suppose the object at index 0 of our mesages array looked like this in our DB.</p>

<pre><code class=" hljs css"><span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">userId</span>:<span class="hljs-value"> <span class="hljs-string">'555'</span>,
  username: <span class="hljs-string">'Joey'</span>,
  message: <span class="hljs-string">'Hey, I can not make the meeting'</span>,
  date: <span class="hljs-string">'Sun Apr 12 2015 22:34:40 GMT-0500 (PST)'</span>
  </span></span></span>}
</code></pre>

<p>Joey later realizes he can make the meeting and wants to update his message which we are allowing on the client side. </p>

<pre><code class=" hljs javascript">Meetings.findById(meetingId, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, meeting)</span> {</span>
  <span class="hljs-comment">// handle errors ..</span>
  <span class="hljs-keyword">var</span> message =  meeting.messages.userId(userId);
  meeting.message = <span class="hljs-string">'Hey, I can go now'</span>;
  meeting.save(callback);
});
</code></pre>

<h2 id="usedaddtosettoinsertintoanarrayifvaluedoesnotexist">Use $AddToSet to insert into an array if value does not exist</h2>

<p>The $addToSet operator adds a value to an array unless the value is already present, in which case $addToSet does nothing to that array.</p>

<p>It takes this form:</p>

<pre><code class=" hljs css"><span class="hljs-tag">Meetings</span><span class="hljs-class">.update</span>(
   <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">_id</span>:<span class="hljs-value"> meetingId </span></span></span>},
   <span class="hljs-rules">{ <span class="hljs-rule">$<span class="hljs-attribute">addToSet</span>:<span class="hljs-value"> { messages: <span class="hljs-string">'hey there'</span> </span></span></span>} }
)
</code></pre>

<p>In this example, we've changed the messages array to be an array of Strings rather than objects. $addToSet will check if 'hey there' already exists in the array and if it doesn't, it will add it to the messages array.</p>

<h3 id="howaboutanarrayofobjects">How about an array of objects?</h3>

<p>$addToSet can also work with an array of objects but they need to be documents first. What does this mean? We need to first create a Schema for the objects that will exist in the array so that Mongoose can use special methods on them. It will also create a unique ID for each of the documents in the array. It would look like this for our meetings collection example:</p>

<pre><code class=" hljs javascript"><span class="hljs-keyword">var</span> Messages = <span class="hljs-keyword">new</span> Schema({
  userId: <span class="hljs-built_in">String</span>,
  username: <span class="hljs-built_in">String</span>,
  message: <span class="hljs-built_in">String</span>,
  date: <span class="hljs-built_in">Date</span> 
});
</code></pre>

<p>And to include our Messages Schema in our Meetings Collection, we could simply write our Meetings Schema like this (abbreviated for simplicity).</p>

<pre><code class=" hljs javascript"> <span class="hljs-keyword">var</span> Meetings = <span class="hljs-keyword">new</span> Schema({
  _id: ObjectId,
  name: <span class="hljs-built_in">String</span>,
  messages: [Messages],
  ... 
});
</code></pre>

<p>Here we have included one Schema inside of another, the Messages Schema in the Meetings Schema. This will allow us to use certain methods when performing queries and updates on the <code>messages</code> array that wouldn't otherwised be available. For instance, doing an $addToSet operation where we check if the message document (object) already exists and if not perform an insert. This could be useful to find out if we've already inserted the message in the DB, perhaps if the user clicks submit twice. Or another use might be to make a similar schema for Users and when someone clicks to join the meeting, add them to the users array only if they are not already in it.</p>

<p>This concludes a brief foray into working with embedded arrays when using Mongoose and MongoDB. </p>
              </section>
              <section class="post-page-share">
                <ul>
                  <span class="date-posted">
                    <li><i class="fa fa-calendar-o"></i> <time itemprop="datePublished" datetime="2015-04-13">13 April 2015</time></li>
                  </span>
                  <span class="share-icons">
                    <li class="share-title">Share on:</li>
                    <li><a href="https://twitter.com/share?text=Tips%20on%20working%20with%20embedded%20arrays%20in%20Mongoose%2FMongo&url=http://www.jonahnisenson.com/tips-on-working-with-embedded-arrays-in-mongoosemongo/" onclick="window.open(this.href, &#39;twitter-share&#39;, &#39;width=550,height=235&#39;);return false;"><i class="fa fa-twitter"></i></a></li>
                    <li><a href="https://www.facebook.com/sharer/sharer.php?u=http://www.jonahnisenson.com/tips-on-working-with-embedded-arrays-in-mongoosemongo/" onclick="window.open(this.href, &#39;facebook-share&#39;,&#39;width=580,height=296&#39;);return false;"><i class="fa fa-facebook"></i></a></li>
                    <li><a href="https://plus.google.com/share?url=http://www.jonahnisenson.com/tips-on-working-with-embedded-arrays-in-mongoosemongo/" onclick="window.open(this.href, &#39;google-plus-share&#39;, &#39;width=490,height=530&#39;);return false;"><i class="fa fa-google-plus"></i></a></li>
                  </span>
                </ul>
              </section>
              <footer>
                <section class="post-page-tags hide-on-desktop hide-on-tablet">
                  <small>Tags</small>
                  <p><a href="http://www.jonahnisenson.com/tag/mongodb/">MongoDB</a> , <a href="http://www.jonahnisenson.com/tag/mongoose/">Mongoose</a> , <a href="http://www.jonahnisenson.com/tag/node-js/">Node.js</a></p>
                </section>

                <section class="post-page-author">
                  <small>About the author</small>
                  <div class="author-wrapper" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                    <ul>
                      <li><a href="http://www.jonahnisenson.com/author/jonah-nisenson/"><img src="./Tips on working with embedded arrays in Mongoose_Mongo_files/0d9cfed41ac9795f7c20dd8440ff5fd9" alt="Jonah Nisenson"></a></li>
                        <li>

                      <h3 rel="author" itemprop="url name"><a href="http://www.jonahnisenson.com/author/jonah-nisenson/">Jonah Nisenson</a></h3>
                        <p>Read <a href="http://www.jonahnisenson.com/author/jonah-nisenson/">more posts</a> by this author.</p>
                      </li>
                    </ul>
                  </div>
                </section>
                <!--<section class="post-page-comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'devthememax'; // required: replace example with your forum shortname

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

-->
              </footer>
          </div>
        </article>
        </div>
    </section>
</span>
<div id="disqus_thread" class="grid-container grid-720"><iframe id="dsq-app1" name="dsq-app1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Tips on working with embedded arrays in Mongoose_Mongo_files/saved_resource.html" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 1403px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe><iframe id="indicator-north" name="indicator-north" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" style="width: 700px !important; border: none !important; overflow: hidden !important; top: 0px !important; min-width: 700px !important; max-width: 700px !important; position: fixed !important; z-index: 2147483646 !important; height: 29px !important; min-height: 29px !important; max-height: 29px !important; display: none !important;"></iframe><iframe id="indicator-south" name="indicator-south" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" style="width: 700px !important; border: none !important; overflow: hidden !important; bottom: 0px !important; min-width: 700px !important; max-width: 700px !important; position: fixed !important; z-index: 2147483646 !important; height: 29px !important; min-height: 29px !important; max-height: 29px !important; display: none !important;"></iframe></div>
<script type="text/javascript">
    var disqus_shortname = 'jonahnisenson'; // required: replace example with your forum shortname
    var disqus_identifier = '';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;</noscript>







            <footer class="main-footer">
              <div class="grid-container grid-720">

                  <section class="copyright">All content copyright <a href="http://www.jonahnisenson.com/">Jonah Nisenson: Journey Into Coding</a> © 2015 • All rights reserved.</section>
                  <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://ghost.org/">Ghost</a></section>

              </div>
            </footer>

        <input type="hidden" id="blog-title" value="Jonah Nisenson: Journey Into Coding">
        <!-- Origami here -->
    </div>




    <script src="./Tips on working with embedded arrays in Mongoose_Mongo_files/jquery.min.js"></script>


    <script src="./Tips on working with embedded arrays in Mongoose_Mongo_files/peeves.js"></script>

    <!--For styling and code lines of inline code-->
    <script type="text/javascript" src="./Tips on working with embedded arrays in Mongoose_Mongo_files/prism.js"></script>




</body></html>